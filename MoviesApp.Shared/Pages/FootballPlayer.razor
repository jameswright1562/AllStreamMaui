@page "/football-player"
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.Components

@inject IJSRuntime JS

<input type="text" @bind="m3uUrl" @bind:event="oninput" />

@if (!string.IsNullOrWhiteSpace(m3uUrl))
{
    <div class="mt-2">
        <video id="fp-video" width="352" height="198" controls playsinline></video>
    </div>
}

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="_content/MoviesApp.Shared/hls-init.js"></script>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public string? url { get; set; }

    private string m3uUrl = string.Empty;
    private string _lastUrlInit = string.Empty;

    protected override Task OnParametersSetAsync()
    {
        if (!string.IsNullOrWhiteSpace(url))
        {
            m3uUrl = url!;
            _lastUrlInit = string.Empty;
        }
        return Task.CompletedTask;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!string.IsNullOrWhiteSpace(m3uUrl) && _lastUrlInit != m3uUrl)
        {
            _lastUrlInit = m3uUrl;
            await JS.InvokeVoidAsync("initHlsPlayer", "fp-video", m3uUrl);
        }
    }
}
