@page "/player/{id}"
@page "/player/tv/{id}/{season:int}/{episode:int}"
@using Microsoft.AspNetCore.Components
@using HtmlAgilityPack
@using AllStream.Shared.Services
@inject NavigationManager Nav
@inject AllStream.Shared.Models.Settings Settings
@inject IJSRuntime JS;
@inject IMovieService MovieService

<PageTitle>@(_pageTitle ?? "Player")</PageTitle>

<div class="mb-4">
    @if (!string.IsNullOrWhiteSpace(_title))
    {
        <h3 class="text-2xl font-bold">@_title</h3>
    }
    @if (!string.IsNullOrWhiteSpace(_subTitle))
    {
        <h5 class="text-gray-400 text-lg">@_subTitle</h5>
    }
</div>

@if(!string.IsNullOrWhiteSpace(_embed) || !string.IsNullOrWhiteSpace(_srcdoc))
{
<div class="aspect-video w-full">
        <iframe class="w-full h-full rounded-lg shadow-lg" @key="@_embed" src="@_embed" name="player" allow="autoplay; encrypted-media; fullscreen" allowfullscreen></iframe>
</div>
}
<div class="mt-4 flex flex-wrap gap-2 items-center">
    <button class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors" @onclick="GoBack">Back</button>
    @if (!string.IsNullOrWhiteSpace(_nextEpisodeUrl))
    {
        <a href="@_nextEpisodeUrl" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">Next Episode</a>
    }
    <div class="text-red-500">@_error</div>
    <div class="text-gray-400">@_status</div>
</div>

@code {


    [Parameter] public string id { get; set; } = string.Empty;
    [Parameter] public int? season { get; set; }
    [Parameter] public int? episode { get; set; }

    string _embed = string.Empty;
    string _srcdoc = string.Empty;
    string _error = string.Empty;
    string _status = string.Empty;
    string _nextEpisodeUrl = string.Empty;
    string _title = string.Empty;
    string _subTitle = string.Empty;
    string _pageTitle = string.Empty;
    bool _requestFullscreen = false;

    HtmlNode? htmlNode;

    protected override async Task OnParametersSetAsync()
    {
        _status = "Building";
        _error = string.Empty;
        _embed = string.Empty;
        _srcdoc = string.Empty;
        _nextEpisodeUrl = string.Empty;
        var key = id;
        if (!string.IsNullOrWhiteSpace(key))
        {
            try
            {
                if (season.HasValue && episode.HasValue)
                {
                    _embed = $"https://vidsrc.to/embed/tv/{key}/{season.Value}/{episode.Value}";

                    try
                    {
                        var details = await MovieService.GetTvDetailsAsync(key);
                        if (details != null)
                        {
                            _title = details.Name;
                            _pageTitle = details.Name;
                        }

                        var episodes = await MovieService.GetTvEpisodesAsync(key, season.Value);
                        
                        var currentEp = episodes.FirstOrDefault(e => e.EpisodeNumber == episode.Value);
                        if (currentEp != null)
                        {
                             _subTitle = $"S{season.Value} E{episode.Value} - {currentEp.Name}";
                             if (!string.IsNullOrWhiteSpace(_pageTitle))
                                _pageTitle += $" - S{season.Value} E{episode.Value}";
                        }
                        else
                        {
                             _subTitle = $"S{season.Value} E{episode.Value}";
                        }

                        if (episodes.Any(e => e.EpisodeNumber == episode.Value + 1))
                        {
                            _nextEpisodeUrl = $"/player/tv/{key}/{season.Value}/{episode.Value + 1}";
                        }
                        else
                        {
                            if (details?.Seasons.Any(s => s.SeasonNumber == season.Value + 1) == true)
                            {
                                _nextEpisodeUrl = $"/player/tv/{key}/{season.Value + 1}/1";
                            }
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error checking next episode: {ex.Message}");
                    }
                }
                else
                {
                    if (key.StartsWith("tt"))
                    {
                        _embed = $"https://vidsrc.to/embed/movie/{key.TrimStart("tt").ToString()}";
                        // Can't easily get details by IMDB ID with current API, but if we had GetMovieDetailsAsync that accepted IMDB ID or we just used the ID passed...
                        // Actually our new GetMovieDetailsAsync takes TMDB ID. 
                        // If key is tt..., it's IMDB ID. 
                        // However, usually we pass TMDB ID to player for movies from the Movies page.
                        // Let's assume key is TMDB ID if it doesn't start with tt, or try both.
                        // But wait, the existing code handles tt prefix.
                    }
                    else
                    {
                        _embed = $"https://vidsrc.to/embed/movie/{key}";
                         try
                        {
                            var movie = await MovieService.GetMovieDetailsAsync(key);
                            if (movie != null)
                            {
                                _title = movie.Title;
                                _pageTitle = movie.Title;
                                _subTitle = movie.Year;
                            }
                        }
                        catch (Exception ex)
                        {
                            Console.WriteLine($"Error fetching movie details: {ex.Message}");
                        }
                    }
                }
                // if (!string.IsNullOrWhiteSpace(Settings.NoAdsProxyBaseUrl))
                // {
                //     var baseUrl = Settings.NoAdsProxyBaseUrl.TrimEnd('/');
                //     var encoded = Uri.EscapeDataString(_embed);
                //     _embed = $"{baseUrl}/embed?url={encoded}";
                // }
                // else if (_embed.Contains("vidsrc"))
                // {
                //     var html = await new HttpClient().GetStringAsync(_embed);
                //     var doc = new HtmlDocument();
                //     doc.LoadHtml(html);
                //     var iframe = doc.DocumentNode.Descendants("iframe").FirstOrDefault();
                //     if (iframe != null)
                //     {
                //         iframe.SetAttributeValue("sandbox", "allow-same-origin allow-scripts");
                //         var inner = iframe.GetAttributeValue("src", string.Empty).TrimEnd("/").ToString();

                //         iframe.SetAttributeValue("src", inner);

                //         _srcdoc = inner;
                //         _embed = string.Empty;
                //     }
                // }
                _requestFullscreen = !string.IsNullOrWhiteSpace(_embed) || !string.IsNullOrWhiteSpace(_srcdoc);
            }
            catch (Exception ex)
            {
                _error = ex.Message;
            }
        }
        _status = string.Empty;
    }

    private async Task GoBack()
    {
        var canGoBack = await JS.InvokeAsync<int>("eval", "history.length");
        if (canGoBack > 1)
            await JS.InvokeVoidAsync("history.back");
        else
            Nav.NavigateTo("/");
    }

    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     if (_requestFullscreen)
    //     {
    //         _requestFullscreen = false;
    //         try
    //         {
    //             await Task.Delay(250);
    //             await JS.InvokeVoidAsync("playerFullscreen");
    //         }
    //         catch
    //         {
    //         }
    //     }
    // }
}
