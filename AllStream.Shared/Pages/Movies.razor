@page "/Movies"
@using AllStream.Shared.Services
@using AllStream.Shared.Models
@inject IFormFactor FormFactor
@inject IMovieService MovieService

<PageTitle>Movies</PageTitle>

<section class="py-8">
    <div class="container mx-auto px-4">
        <h1 class="text-3xl font-bold mb-2">Discover Movies</h1>
        <div class="text-gray-400 mb-6">Search across popular titles and play instantly</div>
        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-sm">
            <div class="p-4">
                <div class="grid grid-cols-12 gap-3">
                    <div class="col-span-12 md:col-span-6">
                        <input class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500" @bind="_opts.Query" placeholder="Search movies" @bind:event="oninput" />
                    </div>
                    <div class="col-span-6 md:col-span-2">
                        <input class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500" type="number" min="1" @bind="_opts.Page" placeholder="Page" />
                    </div>
                    <div class="col-span-6 md:col-span-2">
                        <input class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500" type="text" @bind="_opts.Region" placeholder="Region" />
                    </div>
                    <div class="col-span-6 md:col-span-2">
                        <input class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500" type="number" @bind="_year" placeholder="Year" />
                    </div>
                    <div class="col-span-6 md:col-span-2">
                        <input class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500" type="number" @bind="_primaryReleaseYear" placeholder="Release Year" />
                    </div>
                    <div class="col-span-6 md:col-span-2 flex items-center">
                        <div class="flex items-center space-x-2">
                            <input class="w-4 h-4 bg-gray-900 border-gray-700 rounded focus:ring-blue-500" type="checkbox" id="adult" @bind="_opts.IncludeAdult" />
                            <label class="text-gray-400 select-none" for="adult">Include adult</label>
                        </div>
                    </div>
                    <div class="col-span-12 md:col-span-3">
                        <select class="w-full px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500" @bind="_opts.Language">
                            <option value="en-US">English (US)</option>
                            <option value="en-GB">English (UK)</option>
                            <option value="fr-FR">French</option>
                            <option value="es-ES">Spanish</option>
                        </select>
                    </div>
                    <div class="col-span-12 md:col-span-3">
                        <button class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors font-medium" @onclick="Search">Search</button>
                    </div>
                    <div class="col-span-12 md:col-span-2">
                        <button class="w-full px-4 py-2 border border-gray-600 text-gray-300 hover:bg-gray-700 hover:text-white rounded-md transition-colors" @onclick="Clear">Clear</button>
                    </div>
                </div>
                <div class="text-red-500 mt-2">@_error</div>
                <div class="mt-2 text-gray-400">@(_results.Count) results</div>
            </div>
        </div>
    </div>
</section>
@if (_status == "Loading")
{
    <div class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
    </div>
}
else{
<div class="container mx-auto px-4 pb-12">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
        @foreach (var m in _results)
        {
            <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-sm overflow-hidden flex flex-col h-full">
                @if (!string.IsNullOrWhiteSpace(m.PosterUrl))
                {
                    <img class="w-full h-96 object-cover" src="@m.PosterUrl" alt="@m.Title" />
                }
                <div class="p-4 flex flex-col flex-grow">
                    <h5 class="text-lg font-semibold text-white mb-2 flex justify-between items-start gap-2">
                        <span class="line-clamp-2">@m.Title</span>
                        @if (!string.IsNullOrWhiteSpace(m.Year))
                        {
                            <span class="px-2 py-0.5 text-xs font-semibold bg-gray-700 text-gray-300 rounded shrink-0">@m.Year</span>
                        }
                    </h5>
                    <div class="mt-auto pt-4">
                        <a class="block w-full text-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors font-medium" href="/player/@(string.IsNullOrWhiteSpace(m.ImdbId) ? m.TmdbId : m.ImdbId)">Play</a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>
}

@code {
    MovieSearchOptions _opts = new();
    int? _year;
    int? _primaryReleaseYear;
    string _error = string.Empty;
    string _status = string.Empty;
    List<Movie> _results = new();

    protected override async Task OnInitializedAsync()
    {
        _status = "Loading";
        _results = (await MovieService.SearchAsync(new MovieSearchOptions { Query = string.Empty })).ToList();
        _status = string.Empty;
    }

    async Task Search()
    {
        try
        {
            _status = "Loading";
            _error = string.Empty;
            _opts.Year = _year;
            _opts.PrimaryReleaseYear = _primaryReleaseYear;
            _results = (await MovieService.SearchAsync(_opts)).ToList();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _status = string.Empty;
        }
    }

    async Task Clear()
    {
        _opts = new MovieSearchOptions();
        _year = null;
        _primaryReleaseYear = null;
        await Search();
    }

}
