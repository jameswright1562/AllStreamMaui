@page "/cdnsports"
@using AllStream.Shared.Services
@using AllStream.Shared.Models.CDN
@inject CDNLiveService LiveSport
@inject ILocalStorageService LocalStorage

<PageTitle>Live Sports</PageTitle>

@if (SelectedEvent == null)
{
    <div class="container mx-auto px-4 py-8 max-w-[1400px]">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-3xl font-bold">Live Sports</h1>

            <div class="flex flex-wrap gap-3">
                <select @bind="FilterSport" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All sports</option>
                    @foreach (var s in Sports.Keys.OrderBy(x => x.ToString()))
                    {
                        <option value="@s.ToString()">@s</option>
                    }
                </select>
                <select @bind="FilterCountry" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All countries</option>
                    @foreach (var c in Countries)
                    {
                        <option value="@c">@c</option>
                    }
                </select>

                <select @bind="FilterTournament" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All tournaments</option>
                    @foreach (var t in Tournaments)
                    {
                        <option value="@t">@t</option>
                    }
                </select>

                <select @bind="StatusFilter" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="All">All statuses</option>
                    <option value="Live">Live</option>
                    <option value="Upcoming">Upcoming</option>
                    <option value="Finished">Finished</option>
                </select>

                <select @bind="SortMode" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="LiveFirst">Live first</option>
                    <option value="DateAsc">Date ↑</option>
                    <option value="DateDesc">Date ↓</option>
                </select>
                <button class="px-3 py-2 bg-gray-700 hover:bg-gray-600 border border-gray-600 rounded-md text-white transition-colors" @onclick="ResetFilters">Reset</button>
            </div>
        </header>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="bg-red-900/20 border border-red-500/50 p-3 rounded-lg mb-4 text-red-200">@_error</div>
        }
        @foreach (var sportGroup in GetSportGroups())
        {
            <section class="mb-8 flex flex-col gap-6">
                <h2 class="text-2xl font-bold mb-3">@sportGroup.Key</h2>
                @if (!ApplyFilters(sportGroup.Value).GroupBy(m => m.Country).OrderBy(g => g.Key).Any())
                {
                    <div class="text-gray-400 italic">No matches available</div>
                }
                @foreach (var country in ApplyFilters(sportGroup.Value).GroupBy(m => m.Country).OrderBy(g => g.Key))
                {
                    <h3 class="text-xl font-semibold flex items-center gap-2 mt-4 mb-2">@country.Key                 <img src="@country.First().CountryIMG" class="h-6 w-auto"/>
                    </h3>
                    @foreach (var tournament in country.GroupBy(m => m.Tournament).OrderBy(g => g.Key))
                    {
                        <h4 class="text-lg font-medium text-gray-400 mb-2">@tournament.Key</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            @foreach (var match in ApplySort(tournament))
                            {
                                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700 flex flex-col gap-3 text-white shadow-sm hover:bg-gray-750 transition-colors @(match.Status == GameStatus.Live ? "border-green-500 ring-1 ring-green-500/30" : "")">
                                    <div class="flex justify-between items-center h-6">
                                        @if (match.Status == GameStatus.Live)
                                        {
                                            <span class="bg-green-500 text-black font-bold text-xs px-2 py-1 rounded-full">LIVE</span>
                                        }
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2 flex-1 min-w-0 justify-end text-right">
                                            <span class="whitespace-nowrap overflow-hidden text-ellipsis">@match.HomeTeam</span>
                                            <img src="@match.HomeTeamIMG" class="w-9 h-9 object-contain flex-shrink-0" />
                                        </div>
                                        <span class="font-bold opacity-60 mx-4">VS</span>
                                        <div class="flex items-center gap-2 flex-1 min-w-0 justify-start text-left">
                                            <img src="@match.AwayTeamIMG" class="w-9 h-9 object-contain flex-shrink-0" />
                                            <span class="whitespace-nowrap overflow-hidden text-ellipsis">@match.AwayTeam</span>
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-400">
                                        <span>@match.Start</span>
                                    </div>
                                    <button disabled="@match.NoChannel" class="mt-auto w-full py-2 rounded-md border-none bg-blue-600 text-white font-semibold cursor-pointer hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" @onclick="@(() => { SelectedEvent = match; })">Watch</button>
                                </div>
                            }
                        </div>
                    }
                }
            </section>
        }
    </div>
}
else
{
    <CDNPlayer Match="SelectedEvent" OnBack="BackToList" />
}



@code {
    SportResponse? SelectedEvent;
    IDictionary<Sport, IEnumerable<SportResponse>> Sports = new Dictionary<Sport, IEnumerable<SportResponse>>();
    string _error = string.Empty;

    private string _sortMode = "LiveFirst";
    public string SortMode
    {
        get => _sortMode;
        set { if (_sortMode != value) { _sortMode = value; _ = SaveState(); } }
    }

    private string? _filterSport = string.Empty;
    public string? FilterSport
    {
        get => _filterSport;
        set { if (_filterSport != value) { _filterSport = value; _ = SaveState(); } }
    }

    private string? _filterCountry = string.Empty;
    public string? FilterCountry
    {
        get => _filterCountry;
        set { if (_filterCountry != value) { _filterCountry = value; _ = SaveState(); } }
    }

    private string? _filterTournament = string.Empty;
    public string? FilterTournament
    {
        get => _filterTournament;
        set { if (_filterTournament != value) { _filterTournament = value; _ = SaveState(); } }
    }

    private string _statusFilter = "All";
    public string StatusFilter
    {
        get => _statusFilter;
        set { if (_statusFilter != value) { _statusFilter = value; _ = SaveState(); } }
    }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            var ct = CancellationToken.None;
            Sports = await LiveSport.GetEventsAsync(ct);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var saved = await LocalStorage.GetItemAsync<SavedFilters>("cdn_filters");
            if (saved != null)
            {
                _sortMode = saved.SortMode ?? "LiveFirst";
                _filterSport = saved.FilterSport ?? string.Empty;
                _filterCountry = saved.FilterCountry ?? string.Empty;
                _filterTournament = saved.FilterTournament ?? string.Empty;
                _statusFilter = saved.StatusFilter ?? "All";
                StateHasChanged();
            }
        }
    }

    private async Task SaveState()
    {
        var state = new SavedFilters
        {
            SortMode = SortMode,
            FilterSport = FilterSport,
            FilterCountry = FilterCountry,
            FilterTournament = FilterTournament,
            StatusFilter = StatusFilter
        };
        await LocalStorage.SetItemAsync("cdn_filters", state);
    }

    IEnumerable<SportResponse> ApplySort(IEnumerable<SportResponse> matches)
    {
        return SortMode switch
        {
            "LiveFirst" => matches
                .OrderByDescending(m => m.Status == GameStatus.Live)
                .ThenByDescending(m => m.Channels.Sum(x=>x.Viewers))
                .ThenByDescending(m=>DateTime.Parse(m.Start)),

            "DateAsc" => matches.OrderBy(m => DateTime.Parse(m.Start)),

            "DateDesc" => matches.OrderByDescending(m => DateTime.Parse(m.Start)),

            _ => matches
        };
    }

    IEnumerable<SportResponse> ApplyFilters(IEnumerable<SportResponse> matches)
    {
        var q = matches;
        if (!string.IsNullOrWhiteSpace(FilterCountry)) q = q.Where(m => m.Country == FilterCountry);
        if (!string.IsNullOrWhiteSpace(FilterTournament)) q = q.Where(m => m.Tournament == FilterTournament);
        q = StatusFilter switch
        {
            "Live" => q.Where(m => m.Status == GameStatus.Live),
            "Upcoming" => q.Where(m => m.Status == GameStatus.Upcoming),
            "Finished" => q.Where(m => m.Status == GameStatus.Finished),
            _ => q
        };
        return q;
    }

    IEnumerable<KeyValuePair<Sport, IEnumerable<SportResponse>>> GetSportGroups()
    {
        var all = Sports ?? new Dictionary<Sport, IEnumerable<SportResponse>>();
        if (string.IsNullOrWhiteSpace(FilterSport)) return all.OrderBy(kvp => kvp.Key.ToString());
        return Enum.TryParse<Sport>(FilterSport, out var s)
            ? all.Where(kvp => kvp.Key == s)
            : Enumerable.Empty<KeyValuePair<Sport, IEnumerable<SportResponse>>>();
    }

    IEnumerable<SportResponse> CurrentMatches => string.IsNullOrWhiteSpace(FilterSport)
        ? Sports.Values.SelectMany(x => x)
        : (Enum.TryParse<Sport>(FilterSport, out var s) && Sports.TryGetValue(s, out var ms) ? ms : Enumerable.Empty<SportResponse>());

    IEnumerable<string> Countries => CurrentMatches.Select(m => m.Country).Distinct().OrderBy(x => x);
    IEnumerable<string> Tournaments => CurrentMatches
        .Where(m => string.IsNullOrWhiteSpace(FilterCountry) || m.Country == FilterCountry)
        .Select(m => m.Tournament).Distinct().OrderBy(x => x);

    void ResetFilters()
    {
        FilterSport = string.Empty;
        FilterCountry = string.Empty;
        FilterTournament = string.Empty;
        StatusFilter = "All";
    }

    void BackToList()
    {
        SelectedEvent = null;
    }

    public class SavedFilters
    {
        public string SortMode { get; set; }
        public string? FilterSport { get; set; }
        public string? FilterCountry { get; set; }
        public string? FilterTournament { get; set; }
        public string StatusFilter { get; set; }
    }
}
