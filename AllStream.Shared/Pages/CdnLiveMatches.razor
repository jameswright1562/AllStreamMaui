@page "/cdnsports"
@using AllStream.Shared.Services
@using AllStream.Shared.Models.CDN
@inject CDNLiveService LiveSport
@inject ILocalStorageService LocalStorage

<PageTitle>Live Sports</PageTitle>

@if (SelectedEvent == null)
{
    <div class="container mx-auto px-4 py-8 max-w-[1400px]">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-3xl font-bold">Live Sports</h1>

            <div class="flex flex-wrap gap-3">
                <select @bind="FilterSport" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white">
                    <option value="">All sports</option>
                    @foreach (var s in Sports.Keys.OrderBy(x => x.ToString()))
                    {
                        <option value="@s.ToString()">@s</option>
                    }
                </select>

                <select @bind="FilterCountry" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white">
                    <option value="">All countries</option>
                    @foreach (var c in Countries)
                    {
                        <option value="@c">@c</option>
                    }
                </select>

                <select @bind="FilterTournament" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white">
                    <option value="">All tournaments</option>
                    @foreach (var t in Tournaments)
                    {
                        <option value="@t">@t</option>
                    }
                </select>

                <select @bind="StatusFilter" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white">
                    <option value="All">All statuses</option>
                    <option value="Live">Live</option>
                    <option value="Upcoming">Upcoming</option>
                    <option value="Finished">Finished</option>
                </select>

                <select @bind="SortMode" class="px-3 py-2 bg-gray-900 border border-gray-700 rounded-md text-white">
                    <option value="LiveFirst">Live first</option>
                    <option value="DateAsc">Date ↑</option>
                    <option value="DateDesc">Date ↓</option>
                </select>

                <button class="px-3 py-2 bg-gray-700 hover:bg-gray-600 rounded-md text-white"
                        @onclick="ResetFilters">
                    Reset
                </button>
            </div>
        </header>

        @if (!string.IsNullOrWhiteSpace(_error))
        {
            <div class="bg-red-900/20 border border-red-500/50 p-3 rounded-lg mb-4 text-red-200">
                @_error
            </div>
        }

        @foreach (var sportGroup in GetSportGroups())
        {
            <section class="mb-10">
                <h2 class="text-2xl font-bold mb-4">@sportGroup.Key</h2>
                @{
                    var filteredMatches = ApplyFilters(sportGroup.Value).ToList();
                }
                @foreach (var country in filteredMatches.GroupBy(m => m.Country).OrderBy(g => g.Key))
                {
                    <h3 class="text-xl font-semibold flex items-center gap-2 mb-2">
                        @country.Key
                        <img src="@country.First().CountryIMG" class="h-5 w-auto" />
                    </h3>

                    @foreach (var tournament in country.GroupBy(m => m.Tournament).OrderBy(g => g.Key))
                    {
                        <h4 class="text-sm uppercase tracking-wide text-gray-400 mb-3">
                            @tournament.Key
                        </h4>

                        <!-- MATCH GRID -->
                        <div class="flex flex-wrap gap-5 mb-6 items-start">
                            @foreach (var match in ApplySort(tournament))
                            {
                                <!-- MATCH CARD -->
                                <div class="
                        relative min-w-[260px] max-w-full
                        rounded-xl p-4
                        bg-gradient-to-br from-[#1a2236] to-[#0f172a]
                        border border-white/10
                        shadow-lg shadow-black/30
                        flex flex-col gap-4
                        transition-all duration-200
                        hover:-translate-y-1 hover:shadow-xl
                        @(match.Status == GameStatus.Live
                                             ? "ring-1 ring-green-400/40 border-green-400/40"
                                             : "")">

                                    <!-- LIVE -->
                                    <div class="h-5">
                                        @if (match.Status == GameStatus.Live)
                                        {
                                            <span class="flex items-center gap-1 text-xs font-bold text-green-400">
                                                <span class="relative flex h-2 w-2">
                                                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                                    <span class="relative inline-flex rounded-full h-2 w-2 bg-green-400"></span>
                                                </span>
                                                LIVE
                                            </span>
                                        }
                                    </div>

                                    <!-- TEAMS -->
                                    <div class="min-w-0">

                                        <!-- MOBILE -->
                                        <div class="sm:hidden flex flex-col items-center gap-3 text-center">
                                            <img src="@match.HomeTeamIMG" class="w-16 h-16 object-contain" />
                                            <span class="font-semibold break-words">
                                                @match.HomeTeam
                                            </span>

                                            <span class="text-xs text-gray-400">VS</span>

                                            <img src="@match.AwayTeamIMG" class="w-16 h-16 object-contain" />
                                            <span class="font-semibold break-words">
                                                @match.AwayTeam
                                            </span>
                                        </div>

                                        <!-- DESKTOP -->
                                        <div class="hidden sm:grid w-full
                        grid-cols-[minmax(0,1fr)_auto_minmax(0,1fr)]
                        items-start gap-4">

                                            <!-- HOME -->
                                            <div class="flex items-start justify-end gap-2 min-w-0 pr-1">
                                                <span class="font-medium break-words leading-snug">
                                                    @match.HomeTeam
                                                </span>
                                                <img src="@match.HomeTeamIMG"
                                                     class="w-8 h-8 shrink-0 object-contain" />
                                            </div>

                                            <!-- VS -->
                                            <span class="text-xs font-semibold text-gray-400 text-center">
                                                VS
                                            </span>

                                            <!-- AWAY -->
                                            <div class="flex items-start justify-start gap-2 min-w-0 pl-1">
                                                <img src="@match.AwayTeamIMG"
                                                     class="w-8 h-8 shrink-0 object-contain" />
                                                <span class="font-medium break-words leading-snug">
                                                    @match.AwayTeam
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- TIME -->
                                    <div class="text-xs text-gray-400 flex items-center gap-2">
                                        <i class="fa-regular fa-clock opacity-70"></i>
                                        <span>@match.Start</span>
                                    </div>

                                    <!-- CTA -->
                                    <button disabled="@match.NoChannel"
                                            @onclick="@(() => SelectedEvent = match)"
                                            class="
                            mt-auto w-full
                            py-2.5 rounded-lg
                            font-semibold text-white

                            bg-blue-600
                            hover:bg-blue-700
                            active:bg-blue-700

                            shadow
                            shadow-blue-600/20

                            cursor-pointer
                            transition-all

                            disabled:opacity-40
                            disabled:cursor-not-allowed
                        ">
                                        ▶ Watch
                                    </button>
                                </div>
                            }
                        </div>
                    }
                }
            </section>
        }
    </div>
}
else
{
    <CDNPlayer Match="SelectedEvent" OnBack="BackToList" />
}

@code {
    SportResponse? SelectedEvent;
    IDictionary<Sport, IEnumerable<SportResponse>> Sports = new Dictionary<Sport, IEnumerable<SportResponse>>();
    string _error = string.Empty;

    private string _sortMode = "LiveFirst";
    private string? _filterSport = string.Empty;
    private string? _filterCountry = string.Empty;
    private string? _filterTournament = string.Empty;
    private string _statusFilter = "All";

    public string SortMode { get => _sortMode; set { _sortMode = value; _ = SaveState(); } }
    public string? FilterSport { get => _filterSport; set { _filterSport = value; _ = SaveState(); } }
    public string? FilterCountry { get => _filterCountry; set { _filterCountry = value; _ = SaveState(); } }
    public string? FilterTournament { get => _filterTournament; set { _filterTournament = value; _ = SaveState(); } }
    public string StatusFilter { get => _statusFilter; set { _statusFilter = value; _ = SaveState(); } }

    protected override async Task OnParametersSetAsync()
    {
        try
        {
            Sports = await LiveSport.GetEventsAsync(CancellationToken.None);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        var saved = await LocalStorage.GetItemAsync<SavedFilters>("cdn_filters");
        if (saved != null)
        {
            _sortMode = saved.SortMode ?? "LiveFirst";
            _filterSport = saved.FilterSport ?? string.Empty;
            _filterCountry = saved.FilterCountry ?? string.Empty;
            _filterTournament = saved.FilterTournament ?? string.Empty;
            _statusFilter = saved.StatusFilter ?? "All";
            StateHasChanged();
        }
    }

    async Task SaveState()
    {
        await LocalStorage.SetItemAsync("cdn_filters", new SavedFilters
        {
            SortMode = SortMode,
            FilterSport = FilterSport,
            FilterCountry = FilterCountry,
            FilterTournament = FilterTournament,
            StatusFilter = StatusFilter
        });
    }

    IEnumerable<SportResponse> ApplySort(IEnumerable<SportResponse> matches) =>
        SortMode switch
        {
            "LiveFirst" => matches.OrderByDescending(m => m.Status == GameStatus.Live)
                                  .ThenByDescending(m => DateTime.Parse(m.Start)),
            "DateAsc" => matches.OrderBy(m => DateTime.Parse(m.Start)),
            "DateDesc" => matches.OrderByDescending(m => DateTime.Parse(m.Start)),
            _ => matches
        };

    IEnumerable<SportResponse> ApplyFilters(IEnumerable<SportResponse> matches)
    {
        var q = matches;
        if (!string.IsNullOrWhiteSpace(FilterCountry)) q = q.Where(m => m.Country == FilterCountry);
        if (!string.IsNullOrWhiteSpace(FilterTournament)) q = q.Where(m => m.Tournament == FilterTournament);
        return StatusFilter switch
        {
            "Live" => q.Where(m => m.Status == GameStatus.Live),
            "Upcoming" => q.Where(m => m.Status == GameStatus.Upcoming),
            "Finished" => q.Where(m => m.Status == GameStatus.Finished),
            _ => q
        };
    }

    IEnumerable<KeyValuePair<Sport, IEnumerable<SportResponse>>> GetSportGroups()
    {
        if (string.IsNullOrWhiteSpace(FilterSport)) return Sports;
        return Enum.TryParse<Sport>(FilterSport, out var s)
            ? Sports.Where(x => x.Key == s)
            : Enumerable.Empty<KeyValuePair<Sport, IEnumerable<SportResponse>>>();
    }

    IEnumerable<SportResponse> CurrentMatches =>
        string.IsNullOrWhiteSpace(FilterSport)
            ? Sports.Values.SelectMany(x => x)
            : (Enum.TryParse<Sport>(FilterSport, out var s) && Sports.TryGetValue(s, out var ms) ? ms : Enumerable.Empty<SportResponse>());

    IEnumerable<string> Countries => CurrentMatches.Select(m => m.Country).Distinct();
    IEnumerable<string> Tournaments => CurrentMatches.Select(m => m.Tournament).Distinct();

    void ResetFilters()
    {
        FilterSport = FilterCountry = FilterTournament = string.Empty;
        StatusFilter = "All";
    }

    void BackToList() => SelectedEvent = null;

    public class SavedFilters
    {
        public string SortMode { get; set; }
        public string? FilterSport { get; set; }
        public string? FilterCountry { get; set; }
        public string? FilterTournament { get; set; }
        public string StatusFilter { get; set; }
    }
}
