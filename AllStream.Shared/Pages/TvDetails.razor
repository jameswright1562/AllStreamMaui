@page "/tv/{id}"
@using AllStream.Shared.Services
@using AllStream.Shared.Models
@inject IMovieService MovieService
@inject NavigationManager Nav;

<PageTitle>TV Details</PageTitle>

@if (_details != null)
{
    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
            <div class="md:col-span-4">
                @if (!string.IsNullOrWhiteSpace(_details.PosterUrl))
                {
                    <img class="w-full rounded-lg shadow-md" src="@_details.PosterUrl" alt="@_details.Name" />
                }
            </div>
            <div class="md:col-span-8">
                <h3 class="text-3xl font-bold mb-4">@_details.Name</h3>
                <p class="text-gray-400 text-lg leading-relaxed">@_details.Overview</p>

                <h5 class="text-xl font-semibold mt-8 mb-4">Seasons</h5>
                <div class="flex flex-wrap gap-2">
                    @foreach (var s in _details.Seasons.OrderBy(x => x.SeasonNumber))
                    {
                        <button class="px-3 py-1.5 border border-blue-500 text-blue-400 hover:bg-blue-600 hover:text-white rounded-md text-sm transition-colors @(_selectedSeason == s.SeasonNumber ? "bg-blue-600 text-white" : "")" @onclick="() => LoadSeason(s.SeasonNumber)">
                            Season: @s.SeasonNumber - Episodes: (@s.EpisodeCount)
                        </button>
                    }
                </div>

                @if (_episodes.Count > 0)
                {
                    <h5 class="text-xl font-semibold mt-8 mb-4">Episodes (Season @_selectedSeason)</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        @foreach (var e in _episodes)
                        {
                            <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-sm overflow-hidden flex flex-col h-full">
                                @if (!string.IsNullOrWhiteSpace(e.StillUrl))
                                {
                                    <img class="w-full h-40 object-cover" src="@e.StillUrl" alt="@e.Name"/>
                                }
                                <div class="p-4 flex flex-col flex-grow">
                                    <strong class="text-white block mb-1">Episode @e.EpisodeNumber</strong>
                                    <span class="text-gray-400 text-sm mb-4 line-clamp-2">@e.Name</span>
                                    <button class="w-full mt-auto px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed font-medium" @onclick="() => Play(e.EpisodeNumber)" disabled="@(e.AirDate > DateTime.Now)">Play</button>
                                </div>
                            </div>
                        }
                    </div>
                }

            </div>
        </div>
    </div>
}
else
{
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-center items-center h-64">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
        </div>
        <div class="text-red-500 mt-4 text-center">@_error</div>
    </div>
}

@code {
    [Parameter] public string id { get; set; } = string.Empty;
    AllStream.Shared.Models.TvDetails? _details;
    List<TvEpisode> _episodes = new();
    int _selectedSeason = 0;
    string _error = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        _error = string.Empty;
        _details = await MovieService.GetTvDetailsAsync(id);
        _episodes.Clear();
        _selectedSeason = 0;
    }

    async Task LoadSeason(int seasonNumber)
    {
        _selectedSeason = seasonNumber;
        _episodes = (await MovieService.GetTvEpisodesAsync(id, seasonNumber)).ToList();
        StateHasChanged();
    }

    void Play(int episodeNumber)
    {
        Nav.NavigateTo($"/player/tv/{id}/{_selectedSeason}/{episodeNumber}");
    }
}
