@page "/tv/{id}"
@using AllStream.Shared.Services
@using AllStream.Shared.Models
@inject IMovieService MovieService
@inject NavigationManager Nav;

<PageTitle>TV Details</PageTitle>

@if (_details != null)
{
    <div class="container py-3">
        <div class="row g-3">
            <div class="col-12 col-md-4">
                @if (!string.IsNullOrWhiteSpace(_details.PosterUrl))
                {
                    <img class="img-fluid rounded" src="@_details.PosterUrl" alt="@_details.Name" width="70%"/>
                }
            </div>
            <div class="col-12 col-md-8">
                <h3>@_details.Name</h3>
                <p class="text-secondary">@_details.Overview</p>

                <h5>Seasons</h5>
                <div class="d-flex flex-wrap gap-2">
                    @foreach (var s in _details.Seasons.OrderBy(x => x.SeasonNumber))
                    {
                        <button class="btn btn-outline-primary btn-sm" @onclick="() => LoadSeason(s.SeasonNumber)">
                            Season: @s.SeasonNumber - Episodes: (@s.EpisodeCount)
                        </button>
                    }
                </div>

                @if (_episodes.Count > 0)
                {
                    <h5 class="mt-3">Episodes (Season @_selectedSeason)</h5>
                    <div class="row g-2">
                        @foreach (var e in _episodes)
                        {
                            <div class="col-12 col-md-6 col-lg-4">
                                <div class="card h-100">
                                    @if (!string.IsNullOrWhiteSpace(e.StillUrl))
                                    {
                                        <img class="card-img-top" src="@e.StillUrl" alt="@e.Name"/>
                                    }
                                    <div class="card-body d-flex flex-column text-secondary">
                                        <strong class="text-secondary">Episode @e.EpisodeNumber</strong>
                                        <span class="text-secondary">@e.Name</span>
                                        <button class="btn btn-success btn-sm mt-auto" @onclick="() => Play(e.EpisodeNumber)" disabled="@(e.AirDate > DateTime.Now)">Play</button>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }

            </div>
        </div>
    </div>
}
else
{
    <div class="container py-3">
        <div>Loading...</div>
        <div class="text-danger">@_error</div>
    </div>
}

@code {
    [Parameter] public string id { get; set; } = string.Empty;
    AllStream.Shared.Models.TvDetails? _details;
    List<TvEpisode> _episodes = new();
    int _selectedSeason = 0;
    string _error = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        _error = string.Empty;
        _details = await MovieService.GetTvDetailsAsync(id);
        _episodes.Clear();
        _selectedSeason = 0;
    }

    async Task LoadSeason(int seasonNumber)
    {
        _selectedSeason = seasonNumber;
        _episodes = (await MovieService.GetTvEpisodesAsync(id, seasonNumber)).ToList();
        StateHasChanged();
    }

    void Play(int episodeNumber)
    {
        Nav.NavigateTo($"/player/tv/{id}/{_selectedSeason}/{episodeNumber}");
    }
}
